---
title: VSCodeæ’ä»¶-WebView
date: 2022-03-07 19:31:24
permalink: /pages/11ef97/
categories:
  - æŠ€æœ¯éšç¬”
  - æŠ€æœ¯éšç¬”
tags:
  - VSCodeæ’ä»¶
---

## 0.å‰è¨€

æœ¬ç¯‡åšå®¢è®°å½•çš„æ˜¯ `VSCode` æ’ä»¶çš„ `WebView` æ¨¡å—ã€‚

è®°å½• `webview` å¸¸ç”¨æ“ä½œåŠè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š

1. `webview` çš„åŸºç¡€åˆ›å»ºï¼Œä»¥åŠå¸¸è§ `Opition` è¯´æ˜ã€‚
2. æ›´æ–°é¡µé¢å†…å®¹ã€‚
3. é€šè¿‡ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¯ä»¥å®ç°å¯¹`webview`é¡µé¢äº‹ä»¶çš„æ•è·ï¼Œå¦‚ï¼š`colorTheme`ã€`é”€æ¯äº‹ä»¶` ç­‰ã€‚
4. æœ¬åœ°èµ„æºçš„åŠ è½½æ–¹æ¡ˆ*
5. `Extension `ä¸ `WebView` çš„é€šä¿¡*
6. å½“ `VSCode` è¢«å¼‚å¸¸å…³é—­åï¼Œé‡æ–°æ‰“å¼€åå¦‚ä½•ç»´æŒåŸæœ‰çš„ `webview` çŠ¶æ€ã€‚



## 1.å®æˆ˜æŠ€å·§

### 1.1. å¦‚ä½•åˆ›å»ºä¸€ä¸ª`WebView`ï¼Œå¹¶ä½¿å…¶æ”¯æŒ `js` åŠŸèƒ½

```javascript
// Create and show a new webview
const panel = vscode.window.createWebviewPanel(
  'catCoding', // æ ‡è¯† webview çš„type (åœ¨å†…éƒ¨ä½¿ç”¨)
  'Cat Coding', // Tabs çš„ Title
  vscode.ViewColumn.One, // æŒ‡å®šå±•ç¤ºçš„åŒºåŸŸ(å¦‚ï¼Œç¬¬1ä¸ªCol)
  { enableScripts: true } // Webview çš„ options
);
```

æ³¨æ„ï¼Œæ­¤æ—¶è¿™ä¸€æ­¥åªæ˜¯åˆ›å»ºäº†é¢æ¿ï¼Œéœ€è¦æŒ‡å®š`html`æ˜¾ç¤ºé¡µé¢ï¼Œåœ¨è¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²çš„å½¢å¼å¯¼å…¥æ–‡ä»¶ï¼ˆå› ä¸ºåœ¨`VSCode`æ’ä»¶ä¸­å¼•å…¥å¤–éƒ¨æ–‡ä»¶ä¼šå—åˆ°å®‰å…¨é™åˆ¶çš„å½±å“ï¼Œåé¢ä¼šå•ç‹¬è®²è§£ï¼‰ã€‚

```javascript
// å°† html æŒ‚è½½åˆ° panel é¢æ¿
panel.webview.html = getWebviewContent();

function getWebviewContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
</head>
<body>
    <img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" />
</body>
</html>`;
}
```

> `html` é»˜è®¤æ— æ³•æ‰§è¡Œ `js` ä»£ç ï¼Œéœ€è¦åœ¨ `createWebviewPanel` æ‰“å¼€`enableScripts` å±æ€§ã€‚



### 1.2.æ›´æ–°é¡µé¢å†…å®¹

éå¸¸ç®€å•ï¼Œå¯¹`panel.webview.html` é‡æ–°èµ‹å€¼ `html` å­—ç¬¦ä¸²ã€‚

> è¿™é‡Œäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œè¿™é‡Œå­˜åœ¨æ€§èƒ½é—®é¢˜å§ï¼Œ`VScode`ç»™çš„ä¾‹å­æ˜¯ä¸€ä¸ªä¸æ–­å˜åŒ–çš„çŒ«çš„å›¾ç‰‡ï¼Œæ¯æ¬¡å˜åŒ–éƒ½éœ€è¦é‡æ–°ç”Ÿæˆè¿™æ®µä»£ç ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ `diff` æ“ä½œã€‚

```javascript
const updateWebview = () => {
  panel.title = cat;
  panel.webview.html = getWebviewContent(cat);
};
```



### 1.3.é¢æ¿ç”Ÿå‘½å‘¨æœŸï¼šé”€æ¯|éšè—

ä½¿ç”¨ `createWebviewPanel` åˆ›å»º `panel` åï¼Œæˆ‘ä»¬å¯ä»¥æ•è·è¯¥ `panel` çŠ¶æ€ï¼š

1. é”€æ¯(`dispose`)ï¼šå¯ä»¥é€šè¿‡ `panel.onDidpose` ç”Ÿå‘½å‘¨æœŸæ•è·ã€‚

2. éšè—(`Visibility`)å’Œç§»åŠ¨(`Moving`)ï¼šéƒ½å¯ä»¥é€šè¿‡`onDidChangeViewState` ç”Ÿå‘½å‘¨æœŸæ•è·ã€‚

   - å¯¹äºéšè—çŠ¶æ€ï¼Œå¯ä»¥æŸ¥çœ‹ `panel.visiblity` 
   - å¯¹äºéšè—çŠ¶æ€çš„`webveiw` ,å¯ä»¥è°ƒç”¨ `panel.reveal()` é‡æ–°å”¤é†’
   - `webview ` æ˜¯å¦è¢«é”€æ¯è¿‡ï¼Œå¯ä»¥æŸ¥çœ‹ `panel._store._isDisposed`ã€‚

   > æ›´å¤šçš„å±æ€§æŸ¥çœ‹ï¼Œè¯·é€šè¿‡æ–­ç‚¹`Debug`è°ƒè¯•ã€‚

**ä½¿ç”¨ `onDidDispose` å®ç° `WebView`çš„ é‡æ–°æ¿€æ´»**

```javascript
let currentPanel = vscode.WebviewPanel | undefined // åˆå§‹åŒ–

const columnToShowIn = vscode.window.activeTextEditor
? vscode.window.activeTextEditor.viewColumn
: undefined;

if (currentPanel) {
  // å¦‚æœå·²å­˜åœ¨å˜é‡ï¼Œåˆ™é‡æ–°æ¿€æ´»
  currentPanel.reveal()
  // currentPanel.reveal(columnToShowIn); // reveal è¿˜è¡Œå¯ä»¥æŒ‡å®šæ¿€æ´»çš„åŒºåŸŸ
} else {
  // create a new panel
  currentPanel = vscode.window.createWebviewPanel(
    'webviewID', // æ ‡è¯† webview çš„ ID, å¦‚é‡å¯VSCOdeåç»´æŠ¤çª—ä½“æ—¶éœ€è¦æ­¤å­—æ®µã€‚
    'Cat Coding', // webview çš„ tab title
    columnToShowIn,
    {
      enableScripts: true,
      retainContextWhenHidden: true
    }
  );
  // æ¸²æŸ“ çŒ« çš„é¡µé¢
  currentPanel.webview.html = getWebviewContent('Coding Cat');

  // å…³é—­ webView çš„æ—¶å€™æ¸…ç©ºå®ä¾‹å¯¹è±¡ã€‚
  currentPanel.onDidDispose(
    () => {
      currentPanel = undefined;
    },
    null,
    context.subscriptions
  );
```



**ä½¿ç”¨`onDidChangeViewState` æ›´æ–° `webview`**

```javascript
panel.onDidChangeViewState(
  e => {
    // é€šè¿‡ e.webviewPanel 
    const panel = e.webviewPanel;
    .....
  },
  null,
  context.subscriptions
);
```

ç»“åˆ`switch case`è¯­æ³•

```javascript
panel.onDidChangeViewState(
  e => {
    const panel = e.webviewPanel;
    // ä¸åŒçš„ åŒºåŸŸ æ˜¾ç¤ºä¸åŒçš„ çŒ«å’ª å›¾ç‰‡
    switch (panel.viewColumn) {
      case vscode.ViewColumn.One:
        updateWebviewForCat(panel, 'Coding Cat');
        return;

      case vscode.ViewColumn.Two:
        updateWebviewForCat(panel, 'Compiling Cat');
        return;

      case vscode.ViewColumn.Three:
        updateWebviewForCat(panel, 'Testing Cat');
        return;
    }
  },
  null,
  context.subscriptions
);
```



### 1.4.æœ¬åœ°èµ„æºçš„åŠ è½½

`VScode` æ’ä»¶ä¸å…è®¸ç›´æ¥åŠ è½½æœ¬åœ°èµ„æºï¼Œæ„å‘³ç€ `panel.webview.html` å†…éƒ¨æ‰€æœ‰çš„å¤–éƒ¨èµ„æºéƒ½éœ€è¦é‡æ–°å¤„ç†ã€‚

å¤„ç†æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ‹¼æ¥ç»å¯¹è·¯å¾„åœ°å€

   ```javascript
   import * as path from "vscode"
   path.join(context.extensionPath, 'media', 'cat.gif')
   // æ¨èä½¿ç”¨ path.resolve()
   ```

2. æ·»åŠ  `file://` æ–‡ä»¶åè®®å¤´

   ```javascript
   // DiskPath ç£ç›˜è·¯å¾„
   const onDiskPath = vscode.Uri.file(
     path.join(context.extensionPath, 'media', 'cat.gif')
   );
   ```

   <img src="https://wjs-tik.oss-cn-shanghai.aliyuncs.com/image-20220308102814383.png" style="zoom: 50%;" />

3. è½¬åŒ–ä¸º`VScode` çš„åè®®å¤´ï¼š`vscode-resource:/`

   ```javascript
   const catGifSrc = panel.webview.asWebviewUri(onDiskPath);
   // vscode-resource:/Users/toonces/projects/vscode-cat-coding/media/cat.gif
   ```

   <img src="https://wjs-tik.oss-cn-shanghai.aliyuncs.com/image-20220308103013649.png" style="zoom: 50%;" />

4. æœ€åä¸€æ­¥ï¼Œå°†ç”Ÿæˆçš„æ–°åè®®çš„åœ°å€æ’å…¥åˆ° `html` ä¸­ï¼Œé‡æ„ `html` é¡µé¢ã€‚

   ```html
   <img src="${catGifSrc}" width="300" />
   ```



**æ§åˆ¶èµ„æºçš„è®¿é—®æƒé™**

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ˜¯å°†ä½äºé™æ€æ–‡ä»¶å¤¹ä¸‹(`./media/cat.svg`)çŒ«çš„å›¾ç‰‡æ’å…¥åˆ° `html` ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é™åˆ¶èµ„æºè®¿é—®çš„æ–‡ä»¶å¤¹ï¼Œå¦‚åªå…è®¸è¯»å– `media` ä¸­çš„å›¾ç‰‡èµ„æºã€‚

```javascript
const panel = vscode.window.createWebviewPanel(
  'catCoding',
  'Cat Coding',
  vscode.ViewColumn.One,
  {
    // åªå…è®¸è¯»å– `media` ä¸­çš„å›¾ç‰‡èµ„æºã€‚
    localResourceRoots: [vscode.Uri.file(path.join(context.extensionPath, 'media'))]
  }
);
```

å¦‚æœä¸å…è®¸è¯»å–æ‰€æœ‰æœ¬åœ°èµ„æºï¼Œå¯ä»¥ç›´æ¥å°† `localResourceRoots` è®¾ç½®ä¸º`[]`



### 1.5.`Extension` ä¸ `WebView` çš„é€šä¿¡

**æƒ…å†µ1**ï¼š`Extensions` $\rightarrow$ `WebView`

`Extensions`å¾€`WebView`ä¼ é€’ä¿¡æ¯å¯ä»¥é€šè¿‡ï¼š`webview.postMessage({...})`ï¼Œå¦‚ä¼ é€’`command`

```javascript
// æ³¨å†Œä¸€ä¸ªæ–°çš„ command
context.subscriptions.push(
  vscode.commands.registerCommand('catCoding.doRefactor', () => {
    if (!currentPanel) {
      return;
    }
    // å¯ä»¥ä¼ é€’æ‰€ä»¥å¯ä»¥è¢«`JSON`åºåˆ—åŒ–çš„å†…å®¹
    currentPanel.webview.postMessage({ command: 'refactor' });
})
```

`WebView `æ¥å—ä¿¡æ¯ï¼Œå³ï¼Œè®©`HTML` æ¥å—è¿™ä¸ª `Message`

æ–¹å¼ï¼šå…¨å±€ç›‘å¬ `message` äº‹ä»¶ã€‚

```html
<script>
  // åœ¨ HTML å†…éƒ¨çš„ sript ç›‘å¬ `message` äº‹ä»¶
  window.addEventListener('message', event => {
    const message = event.data; // event.data æ˜¯ä¸€ä¸ª JSON å¯¹è±¡
    switch (message.command) {
      case 'refactor':
        ..... 
        break;
    }
  });
</script>
```

> æ³¨ï¼šä¸ºäº†è®© `HTML`æ”¯æŒ`JS`ä»£ç ï¼Œåœ¨åˆ›å»º`webview`æ—¶ï¼Œè®¾ç½®`{enableSripte: true}`



**æƒ…å†µ2**ï¼š`WebView` $\rightarrow$ `Extensions`

åœ¨ `HTML` çš„ `<script>` æœ‰ä¸€ä¸ªå†…ç½®çš„å‡½æ•°`acquireVSCodeApi`ï¼Œå¯ä»¥å¾—åˆ°`vscode`å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨ `vscode.postMessage` å‡½æ•°å‘`Extensions`ä¼ é€’ã€‚

```javascript
<script>
  (function() {
  const vscode = acquireVsCodeApi();
    if (Math.random() < 0.001 * count) {
      vscode.postMessage({
        command: 'alert',
        text: 'ğŸ›  on line ' + count
      })
    }
  }, 100);
}())
</script>
```

`Extensions` é€šè¿‡`onDidReceiveMessage` é’©å­å‡½æ•°è·å–ä¿¡æ¯ï¼š

```javascript
// Extensions æ¥å— Message
panel.webview.onDidReceiveMessage(
  message => {
    switch (message.command) {
      case 'alert':
        vscode.window.showErrorMessage(message.text);
        return;
    }
  },
  undefined,
  context.subscriptions
);
```

**æ€»ç»“**ï¼š

1. `Extensions` å‘ï¼š`panel.webview.postMessage()`

2. `Extensions `æ”¶ï¼š`panel.webview.onDidReceiveMessage()`

3. `Webview` å‘ï¼š`vscode.postMessage()` ï¼ˆ`vscode` é€šè¿‡å†…ç½®çš„ `acquireVsCodeApi` è·å–ï¼‰
4. `Webview` æ”¶ï¼š `windows.addEventListener("message",event=>{})`



### 1.6.çŠ¶æ€æŒä¹…åŒ–(`Persistence`)

é¦–å…ˆæ˜ç¡®æœ‰å“ªå„¿äº›çŠ¶æ€éœ€è¦è¢«ç¼“å­˜ï¼š

1. `webview` çª—ä½“æœ¬èº«ï¼š`easy`ï¼Œåªéœ€è¦è®°å¿†`panel`å¯¹è±¡å³å¯ã€‚

   > æ³¨ï¼šè¯¥æ“ä½œéœ€è¦ç»´æŒä¸€ä¸ªå…¨å±€çš„`panel`å˜é‡ç”¨äºä¿å­˜çª—ä½“å¯¹è±¡ï¼Œå¦‚æœä¸¢å¤±äº†çª—ä½“å¯¹è±¡ï¼Œå°±æ— æ³•é‡æ–°è·å–ã€‚

2. `webview` çª—ä½“è¢«éšè—ï¼ˆ`panel.visible`ï¼‰æˆ–è€…è¢«é”€æ¯ï¼ˆ`panel.dispose`ï¼‰æ—¶ï¼Œ`webview` åµŒå…¥çš„`html`å†…éƒ¨æ‰€æœ‰çš„çŠ¶æ€ä¼šè¢«ä¸¢å¤±ã€‚

3. æ•´ä¸ª`VSCode`è½¯ä»¶é€€å‡ºï¼Œé‡å¯åï¼Œéœ€è¦é‡æ–°æ˜¾ç¤º`webview`å†…å®¹ã€‚



#### æ–¹æ¡ˆ1ï¼šç»´æŠ¤çª—ä½“æœ¬èº«

> ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡

```javascript
let panel = undefined // åˆå§‹åŒ–

function activate(context) {
  	if (panel) {
      // å¦‚æœå­˜åœ¨ panel å˜é‡ï¼Œé‡æ–°æ¿€æ´»çª—ä½“
      panel.reveal();
    }else{
      // panel undefinedæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„çª—ä½“
      panel = vscode.window.createWebviewPanel(
      "webview_type",
      "Tabs Title",
       1, // æ˜¾ç¤ºçš„ Col
       { enableSript: true} // å„ç§ Options
      );
    }
   // å…³é—­æ—¶ï¼Œé”€æ¯ panel å˜é‡
   panel.onDidDispose(()=>{ panel = undefined},null,context.subscriptions)
}
```



#### æ–¹æ¡ˆ2ï¼šçª—å£éšè—æ—¶ï¼Œä»ç»´æŒçŠ¶æ€

è¿™ç®€å•çš„æ–¹æ¡ˆï¼Œåœ¨åˆ›å»º `webview` æ—¶è®¾ç½®`options`

```javascript
panel = vscode.window.createWebviewPanel(
  "webview_type",
  "Tabs Title",
   1, 
  { 
    enableSript: true,
  	retainContextWhenHidden: true 
  } 
);
```

è®¾ç½® `retainContextWhenHidden` åå°±æ— æ³•å†ä¸ `hidden `çª—ä½“è¿›è¡Œé€šä¿¡ã€‚



#### æ–¹æ¡ˆ3ï¼švscodeé‡å¯åï¼Œç»´æŠ¤çª—ä½“ã€‚

åœ¨åˆ›å»º `webview` æ—¶ï¼Œä¸€ç›´ä¸ç†è§£ç¬¬ä¸€ä¸ª`string` æ ‡è¯†ï¼ŒåŸæ–‡ä¸­ç§°è¯¥å˜é‡ä¸º`webview type`ï¼Œç”¨äºå†…éƒ¨å¯¹çª—ä½“çš„æ ‡è¯†(` Used internally`)ï¼Œå…·ä½“å®è·µæ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»ºæ–°`webview`æ—¶ï¼ŒæŒ‡å®š`webview type`

   ```javascript
   const panel = vscode.window.createWebviewPanel("webview_id","Tabs Title",1,{})
   ```

2. æŒ‡å®š `vscode` é‡å¯åï¼Œè§¦å‘çš„çª—ä½“

   ```javascript
   vscode.window.registerWebviewPanelSerializer(
     'webview_type',
     new RetainContextSerializer()
   );
   ```

   å½“`VSCode` é‡å¯åï¼Œå°†ä¼šè°ƒç”¨ç”± `RetainContextSerializer`  æ„é€ çš„çª—ä½“ã€‚

3. ä¸Šè¿°æ„é€ å‡½æ•°ä¸­çš„å†…å®¹ï¼Œ

   é‡å¯åéœ€è¦æ˜¾ç¤ºçš„é¡µé¢ï¼š`showCatAndCount()`

   é€šè¿‡ `webviewPanel` å¯ä»¥æ‹¿åˆ° `restore` å‰çš„é¢æ¿å¯¹è±¡ï¼Œé‡æ–°èµ‹å€¼ä¸Šé¡µé¢å†…å®¹å³å¯ã€‚

   ```javascript
   class RetainContextSerializer {
   	async deserializeWebviewPanel(webviewPanel, state) {
   		webviewPanel.webview.html = showCatAndCount();
   	}
   }
   ```

4. æœ€åéœ€è¦åœ¨`package.json`ä¸­è®¾ç½®

   ```json
   "activationEvents": [
       ...,
       "onWebviewPanel:catCoding"
   ]
   ```




## 2.å‚è€ƒèµ„æ–™

1. [VSCodeå®˜æ–¹æ’ä»¶æ•™ç¨‹-Webview](https://code.visualstudio.com/api/extension-guides/webview) 



