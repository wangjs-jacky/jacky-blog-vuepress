---
title: 11-Rollupæ‰“åŒ…æœºåˆ¶åŠæ’ä»¶å¼€å‘
date: 2023-04-03 22:43:53
permalink: /pages/d280b4/
categories:
  - ç™¾é—®æ˜é‡‘
  - æ·±å…¥æµ…å‡º Vite
tags:
  - 
---



## 0.å‰è¨€

> æœ¬èŠ‚è¯¾ç¨‹ä»£ç çš„[ä»“åº“ ](https://github.com/wangjs-jacky/Learn-Vite/tree/main/examples/13-vite-rollup)ï¼š`13-vite-rollup`

æ‰¿æ¥ä¸Šæ–‡ï¼Œæœ¬ç¯‡åšå®¢ä¸ºã€Šæ·±å…¥æµ…å‡º `Vite` ã€‹æ˜é‡‘æ‰‹å†Œç¬¬åä¸€ç« çš„æ€»ç»“ã€‚



## 1.æ„å»ºæœºåˆ¶

### é—®é¢˜1ï¼šåœ¨Rollupä¸€æ¬¡å®Œæ•´çš„æ„å»ºè¿‡ç¨‹ä¸­ï¼ŒRollupä¼šç»å†å“ªä¸¤ä¸ªé˜¶æ®µï¼Ÿæ¯ä¸ªé˜¶æ®µçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

`Rollup` å†…éƒ¨ä¼šç»å† `build` å’Œ `output` ä¸¤ä¸ªå¤§é˜¶æ®µ

![](https://wjs-tik.oss-cn-shanghai.aliyuncs.com/202304032250858.png)

ä»£ç é€»è¾‘ç®€åŒ–å¦‚ä¸‹ï¼š

```javascript
// Build é˜¶æ®µ
const bundle = await rollup.rollup(inputOptions);

// Output é˜¶æ®µ
await Promise.all(outputOptions.map(bundle.write));

// æ„å»ºç»“æŸ
await bundle.close();
```

`Build` é˜¶æ®µï¼šé€šè¿‡ `debug` æ–­ç‚¹åï¼Œç®€åŒ– `bundle` å¯¹è±¡ï¼ˆä»¥ç®€åŒ–éƒ¨åˆ†ï¼‰å¦‚ä¸‹ï¼š

```json
{
  /* ç¼“å­˜ ast ç›¸å…³ä¿¡æ¯ */
  cache: {
    modules: [
      {
        assertions: {
        },
        ast: {
          .......
          sourceType: "module",
        },
        /* æ„å»ºåä»£ç  */
        code: "export var add = function (a, b) { return a + b; };\r\nexport var multiple = function (a, b) { return a * b; };\r\n",
        /* å¯¼å…¥çš„æ¨¡å— */
        id: "/Users/jiashengwang/Project/Learn-vite/examples/13-vite-rollup/src/basic/util.ts",
        moduleSideEffects: true,
        /* æºä»£ç  */
        originalCode: "export const add = (a: number, b: number) => a + b;\n\nexport const multiple = (a: number, b: number) => a * b;\n",
      },
    ],
    /* è®°å½•ä½¿ç”¨åˆ°çš„æ’ä»¶ */
    plugins: {},
    close: /* å…³é—­æ„å»º*/
    closed: /* æ ‡è¯†æ„å»ºæ˜¯å¦ç»“æŸ */
    generate: /* ç”Ÿæˆ chunk */
    write: /* å°† chunk å†™å…¥åˆ°ç£ç›˜ */
    watchFiles: [ /* è®°å½•å…¥å£æ–‡ä»¶ç›¸å…³ä¿¡æ¯ */
    "/Users/../examples/13-vite-rollup/src/basic/index.ts",
    "/Users/../examples/13-vite-rollup/src/basic/util.ts",
  	],
  },
```

ä»ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ`Build` é˜¶æ®µä¸»è¦å®Œæˆçš„äº‹æƒ…æœ‰ï¼š

1. `bundle` å¯¹è±¡çš„ `cache.modules` ä¸­å®é™…å­˜å‚¨å„ä¸ªæ¨¡å—çš„å†…å®¹ï¼ˆæºç åŠæ„å»ºåä»£ç ï¼‰ï¼Œæ¨¡å—ä¾èµ–å…³ç³»ï¼Œä»¥åŠè§£æåçš„  `ast` æ ‘ã€‚
2. æš´éœ²å‡ºä¸‰ä¸ªå‡½æ•°ï¼š`generate` ã€ `write` å’Œ`close` æ–¹æ³•ï¼Œç”¨äºè¿›å…¥åˆ°åçš„  `Outup` é˜¶æ®µã€‚ 

`Output` é˜¶æ®µï¼šé€šè¿‡æ‰“æ–­ç‚¹  `const {output} = bundle.generate({})` æŸ¥çœ‹ `output` å¯¹è±¡ã€‚

åˆ†æå¦‚ä¸‹ï¼š

```javascript
// å…¥å£æºç  src/basic/index.ts
import { add, multiple } from "./util";

console.log(add(1, 2));

// ========== æ„å»ºç»“æœ ==========
{
  output: [
    {
      exports: [], /* å½“å‰æ— å¯¼å‡º */
      facadeModuleId: "/Users/jiashengwang/Project/Learn-vite/examples/13-vite-rollup/src/basic/index.ts",
      isEntry: true,
      isDynamicEntry: false, /* æ˜¯å¦ä¸ºåŠ¨æ€å¯¼å…¥å…¥å£æ¨¡å— */
      isImplicitEntry: false, /* æ˜¯å¦ä¸ºéšå¼å…¥å£æ¨¡å— */
      isEntry: true, /* æ˜¯å¦ä¸ºå…¥å£ */
      type: 'chunk', /* ç±»å‹ */
      /* æ‰“åŒ…åçš„ä»£ç  */
      code: "import { add } from './util.85d9f98d.js';\n\nconsole.log(add(1, 2));\r\n/* console.log(multiple(2, 3)); */\n//# sourceMappingURL=index.ce505c09.js.map\n", 
      dynamicImports: [],
      fileName: "index.ce505c09.js", /* æ„å»ºååç§° */
      imports: [
        "util.85d9f98d.js", /* å¯¼å…¥çš„æ¨¡å— */
      ],
      // å…¶ä½™å±æ€§çœç•¥
    }
  ]
}
```

éå…¥å£æ–‡ä»¶åˆ†æï¼š

```javascript
// src/basic/util.ts
export const add = (a: number, b: number) => a + b;
export const multiple = (a: number, b: number) => a * b;

// ========== æ„å»ºç»“æœ ==========
{
  output: [
    {
      /* å¯¼å‡ºçš„æ–¹æ³• */
      exports: [
        "add",
        "multiple",
    	], 
      facadeModuleId: "/Users/../examples/13-vite-rollup/src/basic/util.ts",
      isDynamicEntry: false,
      isImplicitEntry: false, 
      isEntry: true,
      type: 'chunk', /* ç±»å‹ */
      /* æ‰“åŒ…åçš„ä»£ç  */
      code: "var add = function (a, b) { return a + b; };\r\nvar multiple = function (a, b) { return a * b; };\n\nexport { add, multiple };\n//# sourceMappingURL=util.85d9f98d.js.map\n",
      dynamicImports: [],
      fileName: "util.85d9f98d.js", /* æ„å»ºååç§° */
      imports: [],
      // å…¶ä½™å±æ€§çœç•¥
    }
  ]
}
```

å¯¹åº” `map` æ–‡ä»¶ç»“æ„ï¼š

```javascript
{
  output: [
    {
      fileName: "index.ce505c09.js.map",
      source: "{\"version\":3,\"file\":\"index.ce505c09.js\",\"sources\":[],\"sourcesContent\":[],\"names\":[],\"mappings\":\";;;\"}",
      type: "asset", /* ç±»å‹ä¸º assets */
    },
    {
      fileName: "util.85d9f98d.js.map",
    }
  ]
}
```

æœ€ç»ˆçš„è¾“å‡ºç»“æœï¼š

<img src="/Users/jiashengwang/Library/Application Support/typora-user-images/image-20230403232858652.png" alt="image-20230403232858652" style="zoom:80%;" />



### é—®é¢˜2ï¼šrollup ä¸­ Build Hook å’Œ Output Hook çš„æœ¬è´¨åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

æ’ä»¶çš„å„ç§ Hook å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæ„å»ºé˜¶æ®µåˆ†ä¸ºä¸¤ç±»: `Build Hook` ä¸ `Output Hook`ã€‚

- `Build Hook`ï¼šæ˜¯ä»¥ `module` ä½œä¸ºå¤„ç†è¾¹ç•Œã€‚
- `Output Hook`ï¼šåˆ™æ˜¯ä»¥ `Chunk` ä½œä¸ºå¤„ç†è¾¹ç•Œã€‚



### é—®é¢˜3ï¼šæ ¹æ® Hook æ‰§è¡Œæ–¹å¼å¯ä»¥æŠŠæ’ä»¶åˆ†æˆå“ªäº”ç±»ï¼Ÿ

`Rollup` ä¸­çš„é’©å­ç±»å‹åº”è¯¥ä¹Ÿæ˜¯å‚è€ƒ `tabpable` è¿™ä¸ªåº“ã€‚

`hook`é’©å­ç±»å‹å¤§è‡´å¯ä»¥åˆ†ä¸º 5 ç±»ï¼š

1. åŒæ­¥`Sync` or éåŒæ­¥ `Async`ã€‚
2. å¹¶è¡Œ`Parallel` or ä¸²è¡Œ`Sequential` ï¼šç±»æ¯” `Promise.all` å’Œ `async + await`
3. `First`ï¼šç±»æ¯” `Promise.race` ä»…å¤„ç†ç¬¬ä¸€ä¸ªè¿”å›å€¼ã€‚

ä¸Šè¿°åˆ†ç±»å¤ªå…«è‚¡äº†ç‚¹ï¼ŒèƒŒä½å³å¯ï¼Œå®é™…æµç¨‹è¿˜æ˜¯æŒºç®€å•çš„ã€‚



### é—®é¢˜4ï¼šè¯·æè¿°ä¸€ä¸‹Rollupæ’ä»¶åœ¨buildé˜¶æ®µçš„å·¥ä½œæµç¨‹ï¼Ÿ

`Build` çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58ce9fa2b0f14dd1bc50a9c849157e43~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

ä¸»è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹å³å¯ï¼š

1. å¯¹äºå¤šä¸ªæ’ä»¶çš„å¯åŠ¨æ˜¯å¹¶å‘çš„ï¼Œå› æ­¤æ„å»ºå¼€å§‹é˜¶æ®µ `buildStart `ä¸º `parallel` æ¨¡å¼ã€‚

2. è€Œå•ä¸ªæ’ä»¶å†…éƒ¨çš„æ‰§è¡Œæµç¨‹æ˜¯ä¸²è¡Œçš„ã€‚

   å…¶ä¸­è´Ÿè´£è§£æ `module` çš„é’©å­ï¼Œå³ `resolve` + `load` ç±»å±äº `First` å‹ã€‚å½“æŸä¸ªæ¨¡å—è¢«æ’ä»¶å¤„ç†è¿‡åï¼Œå…¶ä»–æ¨¡å—æ— æ³•å¤„ç†äº†ï¼Œå¦‚æœæ­¤æ—¶ä»éœ€å¤„ç†ï¼Œå¯é€šè¿‡ `this.resolve()` å‘èµ·äºŒæ¬¡æ¨¡å—è§£ææ“ä½œï¼Œè¿™ä¸€ç‚¹ç‰¹æ€§åœ¨`rollup` æ’ä»¶é˜¶æ®µçš„ `alias` æ’ä»¶æ—¶ä½“ç°çš„å¾ˆæ˜æ˜¾ã€‚

3. **æ ¸å¿ƒæ„å»ºæµç¨‹**ï¼š`resolve `=> `load` => `transform`ï¼ˆå­—ç¬¦ä¸²åˆ°å­—ç¬¦ä¸²ï¼‰=> `moduleParse`ï¼ˆå­—ç¬¦ä¸²åˆ° `ast` æ ‘ï¼Œè¿™ä¸ªé˜¶æ®µå¾ˆè€—æ—¶å¯ä»¥æ˜¯å¹¶å‘æ¨¡å¼ï¼‰



### é—®é¢˜5ï¼šè¯·æè¿°ä¸€ä¸‹Rollupæ’ä»¶åœ¨Outputé˜¶æ®µçš„å·¥ä½œæµç¨‹ï¼Ÿ

**`Output` çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5dc4935d712d451fb6978fad46dd7b74~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

Build å’Œ Output å…¶å®ä¹ŸæŒºåƒçš„ï¼Œåªæ˜¯å‰è€…å¤„ç† `moudle`ï¼Œæˆ–è€…å¤„ç† `chunk`ï¼Œå¦‚ä½• `emit` åˆ°ç£ç›˜ï¼š

1. åœ¨æ‰§è¡Œå¤šä¸ªæ’ä»¶æ—¶åŸºæœ¬éƒ½æ˜¯å¹¶å‘çš„ã€‚å¦‚`renderStart` ä¸­å¹¶å‘æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„ `banner\footer\intro\outro` é’©å­ã€‚è¿™å››ä¸ªé’©å­åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯å¾€æ‰“åŒ…äº§ç‰©çš„å›ºå®šä½ç½®(æ¯”å¦‚å¤´éƒ¨å’Œå°¾éƒ¨)æ’å…¥ä¸€äº›è‡ªå®šä¹‰çš„å†…å®¹ï¼Œæ¯”å¦‚åè®®å£°æ˜å†…å®¹ã€é¡¹ç›®ä»‹ç»ç­‰ç­‰ã€‚
2. `writeBundle` ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ„å»ºç»“æŸåï¼Œ`output` ç»“æœä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ ¹æ®æ•°ç»„ä¸­çš„ `filename` å»å¾€ç£ç›˜ä¸­è¾“å‡ºäº§ç‰©ã€‚
3. ç‰¹æ®Šçš„é’©å­è§£æï¼š
   - `augmentChunkHash`ï¼šå†³å®šæ˜¯å¦è¦ä»¥ `hash` æ–¹å¼å‘½åã€‚
   - `resolveFileUrl`ï¼šä¹‹å‰åœ¨æ„å»º `__dirname` æ—¶æœ‰ä½¿ç”¨è¿‡ï¼Œæ­¤é˜¶æ®µé‡åˆ° `import.meta.url` è¯­å¥æ—¶ï¼Œå¯é€šè¿‡æ­¤å‡½æ•°è§£æã€‚ï¼ˆè·¯å¾„è§£æç±»çš„éƒ½å±äº `First` å‹ï¼‰
   - `resolveImportMeta`ï¼šå¯¹äº `import.meta.å±æ€§` è¯­å¥æ—¶ï¼Œå¯é€šè¿‡æ­¤å‡½æ•°è§£æã€‚ï¼ˆè·¯å¾„è§£æç±»çš„éƒ½å±äº `First` å‹ï¼‰
4. **æ„å»ºçš„æ ¸å¿ƒæµç¨‹**ï¼š `renderChunk`=>`generateBundle`=>`writeBundle`



## 2. å®˜æ–¹æ’ä»¶æºç è§£æ

### é—®é¢˜6ï¼šå¦‚ä½•å®ç°åˆ«åæ›¿æ¢ `alias` æ’ä»¶ï¼Ÿ

> å®˜æ–¹ [`alias` æ’ä»¶](https://github.com/rollup/plugins/blob/master/packages/alias/src/index.ts) åŠŸèƒ½å¾ˆå…¨ï¼Œæˆ‘åœ¨ [ä»“åº“ ](https://github.com/wangjs-jacky/Learn-Vite/blob/main/examples/13-vite-rollup/scripts/plugins/alias-plugin.ts)ä¸­ä»…å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```javascript
// å®˜æ–¹æ’ä»¶
import alias from "@rollup/plugin-alias";
// å¸¸ç”¨ inputOptions é…ç½®
const inputOptions = {
  input: path.join(SRC_PATH, "plugin", "alias.js"),
  plugins: [
    otherPlugin(),
    myAlias({
      /* å°† util-a è¿™ä¸ªè™šå‡æ¨¡å—æ›¿æ¢ä¸º ./util.js ç›¸å¯¹ */
      entries: [{ find: "util-a", replacement: "./util.js" }],
    }),
    /* å®˜æ–¹ç”¨æ³• */
    alias({
      entries: [{ find: "util-b", replacement: "./util.js" }],
    }),
  ],
};
```

å…¶ä¸­ï¼Œ`util-a` å’Œ `util-b` ä¸ºä¸¤ä¸ªè™šæ‹Ÿæ¨¡å—ï¼Œä½¿ç”¨å®˜æ–¹å®è·µå¤„ç† `util-b`ï¼Œä½¿ç”¨`myAlias` å¤„ç† `util-a`ã€‚

```javascript
import { add } from "util-a";
import { multiple } from "util-b";
```

å®è·µæ€è·¯ï¼š

1. é€šè¿‡ `resolveId` ç­›é€‰å‡º `util-a` æ¨¡å—ï¼Œç­›é€‰åé€šè¿‡å­—ç¬¦ä¸²çš„ `replace` å‡½æ•°æ›¿æ¢æˆç›®æ ‡æ¨¡å—`./util.js`ã€‚
2. ç‰¹åˆ«æ³¨æ„æ—¶ï¼Œç”±äº `resolveId` å±äº`First` å‹ï¼Œå½“ `myAlias` å¤„ç†åï¼Œåç»­æ‰€æœ‰çš„æ’ä»¶å°†ä¸å†å¤„ç†æ­¤æ¨¡å—ï¼Œéœ€è€ƒè™‘ä¸€ä¸ªæƒ…å†µï¼Œå°±æ˜¯è½¬è¯‘åçš„ `./util.js` æœ‰å¯èƒ½è¿˜ä¼šè¢«äºŒæ¬¡å¤„ç†ã€‚å› æ­¤éœ€è¦é€šè¿‡ `this` ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œæ¨¡å—äºŒæ¬¡è§¦å‘ã€‚
3. ç¬¬äºŒæ¬¡è§¦å‘æ—¶ï¼Œ`myAlias` ä¸éœ€è¦å†è¿›è¡Œå¤„ç†äº†ï¼Œé€šè¿‡é€ä¼  `{ skipSelf: true }` å¯è·³è¿‡å½“å‰æ’ä»¶ã€‚

ç®€æ˜“ç‰ˆä»£ç å¦‚ä¸‹ï¼š

```javascript
/* ç®€æ˜“ç‰ˆ-å®˜æ–¹æ’ä»¶ï¼Œç»æ”¯æŒ find(ä¸æ”¯æŒæ­£åˆ™) å’Œ replacement ä¸¤ä¸ªå‚æ•° */
function myAlias(options) {
  // è·å– entries é…ç½®
  const { entries } = options;
  return {
    name: "myAlias",
    // ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œå½“å‰æ¨¡å—è·¯å¾„ã€å¼•ç”¨å½“å‰æ¨¡å—çš„æ¨¡å—è·¯å¾„ã€å…¶ä½™å‚æ•°
    resolveId(importee, importer, resolveOptions) {
      log(importee, importer, "alias-plugin");
      // æ ¹æ® find è¿‡æ»¤å‡ºæ¨¡å—
      const matchedEntry = entries.find(
        (entry) =>
          /* matches(entry.find, importee), */
          entry.find === importee,
      );
      /* åˆ¤æ–­æ˜¯å¦ä¸ºå…¥å£æ¨¡å— */
      const isEntry = !importer;

      // å¦‚æœä¸èƒ½åŒ¹é…æ›¿æ¢è§„åˆ™ï¼Œæˆ–è€…å½“å‰æ¨¡å—æ˜¯å…¥å£æ¨¡å—ï¼Œåˆ™ä¸ä¼šç»§ç»­åé¢çš„åˆ«åæ›¿æ¢æµç¨‹
      if (!matchedEntry || isEntry) {
        return null;
      }

      // æ‰§è¡Œæ›¿æ¢æ“ä½œ
      const updatedId = importee.replace(
        matchedEntry.find,
        matchedEntry.replacement,
      );

      /* ===== END ===== */
      /* ç†è®ºä¸Šæ›¿æ¢å®Œæˆåï¼Œç›´æ¥ return string æˆ–å¯¹è±¡ å³å¯ï¼Œä½†æ˜¯ä»éœ€è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œ
      è½¬è¯‘åçš„æ¨¡å—(æœ¬ä¾‹ä¸­ä¸º "./util.js")éœ€ä¸éœ€è¦è¢«å…¶ä»–æ¨¡å—æ‰€å¤„ç†ã€‚*/
      /* å› æ­¤ï¼šéœ€é€šè¿‡  this.resolve ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶(é™¤å½“å‰æ’ä»¶å¤–)çš„ resolveId é’©å­ï¼Œé‡æ–°å‘èµ·ä¸€è½®æ„å»ºå»å¤„ç† "./util.js" ä¾èµ–ã€‚ */
      /* æ–°ä¸€è½®ä¾èµ–å¤„ç†ï¼Œå½“å‰æ’ä»¶æ— éœ€å¤„ç†ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•° {skipSelf: true} è·³è¿‡ */
      console.log("\nè§¦å‘ç¬¬äºŒè½®ä¾èµ–è§£æ......\n");
      return this.resolve(
        updatedId,
        importer,
        Object.assign({ skipSelf: true }, resolveOptions),
      ).then((resolved) => {
        // æ›¿æ¢åçš„è·¯å¾„å³ updateId ä¼šç»è¿‡åˆ«çš„æ’ä»¶è¿›è¡Œå¤„ç†
        /* å¦‚æœæ˜¯ä¸ªçœŸå®çš„åœ°å€ï¼Œæœ€ç»ˆä¼šè¢« rollup æ›¿æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œè‹¥ä¸ºè™šæ‹Ÿæ¨¡å—çš„è¯ */

        let finalResult = resolved;
        if (!finalResult) {
          // å¦‚æœå…¶å®ƒæ’ä»¶æ²¡æœ‰å¤„ç†è¿™ä¸ªè·¯å¾„ï¼Œåˆ™ç›´æ¥è¿”å› updateId
          finalResult = { id: updatedId };
        }
        return finalResult;
      });
    },
  };
}
```

è¿™è¾¹ä¸ºäº†èƒ½æ›´å¥½çš„çœ‹å‡ºäºŒæ¬¡ä¾èµ–è§£æçš„è¿‡ç¨‹ï¼Œå°è£… `log` å‡½æ•°æ‰“å°å¤„ç†ç»“æœã€‚

```javascript
function log(importee, importer, pluginName) {
  const isEntry = !importer;
  if (isEntry) {
    console.log(`${pluginName}è§£æ: å…¥å£æ–‡ä»¶`);
  } else {
    console.log(`${pluginName}è§£æ: ${importee}`);
  }
}
```

æ‰§è¡Œï¼š`npm run plugin:alias` ï¼Œæ‰“å°ç»“æœå¦‚ä¸‹ï¼š

```shell
otherPluginè§£æ: å…¥å£æ–‡ä»¶
myAliasè§£æ: å…¥å£æ–‡ä»¶ 
otherPluginè§£æ: util-a
otherPluginè§£æ: util-b
myAliasè§£æ: util-a

è§¦å‘ç¬¬äºŒè½®ä¾èµ–è§£æ......

myAliasè§£æ: util-b
otherPluginè§£æ: ./util.js
otherPlugin å¯ä»¥æ•è·åˆ°ç» alias æ’ä»¶ replace åçš„æ¨¡å—
otherPluginè§£æ: ./util.js
otherPlugin å¯ä»¥æ•è·åˆ°ç» alias æ’ä»¶ replace åçš„æ¨¡å—
myAliasè§£æ: ./util.js
ğŸš€ Build Finished!
```

å¯ä»¥å‘ç°å¦‚ä¸‹ï¼š

- æ’ä»¶ç”Ÿæ•ˆæ—¶ä¸º**å¹¶å‘**ï¼Œå› æ­¤ä¸¤ä¸ªæ’ä»¶ `myAlias` å’Œ `otherPlugin` åŒæ—¶å¤„ç†å…¥å£ä¾èµ–ã€‚ä¸”æ•´ä½“æ‰§è¡Œæ¬¡åºæŒ‰ç…§`plugins` çš„ä¹¦å†™é¡ºåºã€‚

  ```shell
  otherPluginè§£æ: å…¥å£æ–‡ä»¶
  myAliasè§£æ: å…¥å£æ–‡ä»¶ 
  ```

- å•ä¸ªæ’ä»¶å±äºä¸²è¡Œï¼Œå› æ­¤ä¸¤ä¸ªæ’ä»¶ä¼šä¾æ¬¡è§¦å‘è§£æ `util-a` å’Œ `util-b` ä¸¤ä¸ªåŒ…ã€‚

  ```shell
  otherPluginè§£æ: util-a
  otherPluginè§£æ: util-b
  myAliasè§£æ: util-a 
  // è°ƒç”¨ this.resolve æ­¤ä¸º async æ¨¡å¼ã€‚
  myAliasè§£æ: util-b
  ```

  å› ä¸º `util-a` ç¬¦åˆ `alias` çš„ `find` æ¡ä»¶ï¼Œä¼šè¢«è½¬è¯‘ä¸º `./util.js`ï¼Œè§¦å‘äºŒæ¬¡ä¾èµ–è§£æã€‚ä¼šåœ¨ `myAlias` è§¦å‘ç»“æŸåæ‰§è¡Œ `this.resolve` å‡½æ•°ã€‚è¿™å°±æ˜¯ `hook` é’©å­ä¸º `async` çš„ä½“ç°ã€‚

- ç”±äº `{ skipSelf: true }` äºŒæ¬¡æ„å»ºæ—¶ï¼Œåªæœ‰ `otherPlugin`  å’Œå®˜æ–¹çš„ `alias` å‚ä¸è§£æã€‚

  ```shell
  otherPluginè§£æ: ./util.js
  otherPlugin å¯ä»¥æ•è·åˆ°ç» alias æ’ä»¶ replace åçš„æ¨¡å—
  ```

  å½“ `alias` æ¨¡å—è§£æåˆ° `util-b` æ—¶ï¼Œä¹Ÿä¼šè§¦å‘äºŒæ¬¡æ„å»ºï¼Œå› æ­¤æœ€åæ‰§è¡Œï¼š

  ```shell
  otherPluginè§£æ: ./util.js
  otherPlugin å¯ä»¥æ•è·åˆ°ç» alias æ’ä»¶ replace åçš„æ¨¡å—
  ```

åˆ†æç»“æŸï¼Œæ„Ÿè§‰æˆ‘è¿™ä¸ªä¾‹å­è®¾è®¡çš„è¶…çº§å¥½ï¼Œè¯»æ‡‚è¿™ä¸ªä¾‹å­å°±èƒ½å®Œå…¨æ˜ç™½ `hook` 5ç§ç±»å‹çš„å®é™…å«ä¹‰äº†ã€‚



### é—®é¢˜7ï¼šå¦‚ä½•æ”¯æŒå›¾ç‰‡åŠ è½½ `image` æ’ä»¶ï¼Ÿ

> å®˜æ–¹ [`image` æ’ä»¶](https://github.com/rollup/plugins/blob/master/packages/image/src/index.js) ï¼Œ [ä»“åº“ ](https://github.com/wangjs-jacky/Learn-Vite/blob/main/examples/13-vite-rollup/scripts/plugins/image-plugin.ts)ä»…å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬ã€‚
>
> ç›¸å½“äº`webpack` çš„  `file-loader`  æ’ä»¶å»å¤„ç†å›¾ç‰‡ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```javascript
// å¸¸ç”¨ inputOptions é…ç½®
const inputOptions = {
  input: path.join(SRC_PATH, "plugin", "image.js"),
  plugins: [
    myImage({
      dom: true, 
    }),
  ],
};
```

`myImage` æ’ä»¶æ”¯æŒä¸€ä¸ª `dom` å‚æ•°ï¼Œå¼€å¯åå¯å¦‚ä¸‹ä½¿ç”¨ï¼š

```java
import logo from './rollup.png';
document.body.appendChild(logo);
```

æ¶‰åŠä¾èµ–å¤„ç†æµç¨‹ï¼š`resolve` => `load` 

**å®ç°æ€è·¯ï¼š**

1. ä½¿ç”¨ `resolveId` æ‹¦æˆª`.png`  ç­‰åç¼€å›¾ç‰‡æ¨¡å—ï¼ˆç”±äºå¤ªè¿‡ç®€å•ï¼Œåœ¨`load` é’©å­ä¸­ä¹Ÿå¯ç›´æ¥å®Œæˆï¼‰

2. åœ¨ `load` é’©å­å‡½æ•°ä¸­ï¼Œä½¿ç”¨ `fs.readFileSync(xxx,"base64")` ä»¥ `base64` çš„æ–¹å¼è¯»å–å›¾ç‰‡èµ„æºã€‚ 

   å¦‚æœ `dom:false`ï¼Œåˆ™ç›´æ¥è¿”å› `base64`ï¼Œæ„é€  `export default ${dataUri}` å³å¯ã€‚

   å¦‚æœ `dom:true`ï¼Œé€šè¿‡ `new Image` åˆ›å»ºä¸€ä¸ª  `<img>` æ ‡ç­¾åè¿”å›ï¼Œå¦‚ä¸‹ï¼š

   ```javascript
   function domeTemplate({dataUri}){
     return `
     var img = new Image();
     img.src = "${dataUri}";
     export default img;
     `;
   }
   ```



é¢å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹ä¸åŒæ ¼å¼çš„å›¾ç‰‡å¤„ç†é€»è¾‘æœ‰æ‰€ä¸åŒï¼š

1. å¯¹äº `img` å›¾ç‰‡ï¼šç›´æ¥ `fs.readFileSync("xxx.png","base64")` è·å– `dataUri`
2. å¯¹äº `svg` å›¾ç‰‡ï¼šå¯¹äº `svg` æ ¼å¼çš„å›¾ç‰‡ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ä»¥ `base64` çš„æ–¹å¼è¯»å–ï¼Œè€Œæ˜¯é€šè¿‡ `fs.readFileySync("xxx.svg","utf-8")` çš„æ–¹å¼è·å– `svg` å­—ç¬¦ä¸²ï¼Œå†é€šè¿‡`mini-svg-data-uri` è¿™ä¸ªç¬¬ä¸‰æ–¹åº“è·å–å‹ç¼©åçš„ `dataUri`ã€‚



**ç®€åŒ–ç‰ˆçš„ä»£ç ï¼š**

```javascript
const defaultOption = {
  dom: false,
  exclude: null,
  include: null,
};

function myImage(opts = {}) {
  const options = { ...defaultOption, ...opts };
  return {
    name: "rollup:image",
    load(id) {
      /* 1. è·å–æ–‡ä»¶åç¼€å */
      const fileExtname = path.extname(id);
      const mime = mimeTypes[fileExtname];

      if (!mime) {
        /* éå›¾æ ‡æ ¼å¼æ–‡ä»¶ */
        return null;
      }

      const isSvg = fileExtname === ".svg";
      const format = isSvg ? "utf-8" : "base64";
      const source = fs.readFileSync(id, format).replace(/[\r\n]+/gm, "");
      const dataUri = isSvg
        ? svgToMiniDataURI(source)
        : `data:${mime};${format},${source}`;
      const code = options.dom
        ? domTemplate({ dataUri })
        : constTemplate({ dataUri });
      return code.trim();
    },
  };
}

function domTemplate({ dataUri }) {
  return `
  var img = new Image();
  img.src = "${dataUri}";
  export default img;
  `;
}

function constTemplate({ dataUri }) {
  return `
  var img = "${dataUri}";
  export default img;
  `;
}

async function build() {
  const bundle = await rollup.rollup(inputOptions);
  await bundle.write({
    dir: path.join(DIST_PATH, "plugin", "image"),
    format: "cjs",
  });
}

build()
  .then(() => {
    console.log("ğŸš€ Build Finished!");
  })
  .catch((error) => {
    console.log("rollup failed", error);
  });
```



### é—®é¢˜8ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªå…¨å±€æ›¿æ¢ `replace` æ’ä»¶ï¼Ÿ

> å®˜æ–¹ [`replace` æ’ä»¶](https://github.com/rollup/plugins/blob/master/packages/replace/src/index.js) ï¼Œ [ä»“åº“ ](https://github.com/wangjs-jacky/Learn-Vite/blob/main/examples/13-vite-rollup/scripts/transform/replace-plugin.ts)ä»…å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```javascript
// å¸¸ç”¨ inputOptions é…ç½®
const inputOptions = {
  input: path.join(SRC_PATH, "plugin", "replace.js"),
  external: [],
  plugins: [
    replace({
      "process.env.Jacky": "'Jack!!!'",
    }),
    myReplace({
      "process.env.Hello": "'Jack!!!'",
      /* æ”¯æŒå›è°ƒå½¢å¼ï¼Œä¸”å›è°ƒä¸­å¯è·å–æ¨¡å—id */
      "process.env.World": () => "'Jack!!!'",
       delimiters: ["\\b", "\\b(?!\\.)"],
    }),
  ],
};
```

æµ‹è¯•æ–‡æœ¬å¦‚ä¸‹ï¼š

```javascript
console.log("process.env.Jacky", process.env.Jacky);
console.log("process.env.Hello", process.env.Hello);
console.log("process.env.World", process.env.World);
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```javascript
'use strict';

console.log("'Jack!!!'", 'Jacky!!!');
console.log("'Jack!!!'", 'Jack!!!');
console.log("'Jack!!!'", 'Jack!!!');
```



**å®ç°æ€è·¯**ï¼š

- è¿™ä¸ªæ’ä»¶åŠŸèƒ½æ˜¯å…¸å‹çš„`transform` åŠŸèƒ½ï¼Œå³ `string => string`
- æ ¸å¿ƒæ€è·¯æ˜¯ï¼Œé€šè¿‡ `transform(code,id)` å¯ä»¥è·å–å­—ç¬¦ä¸²ï¼Œé€šè¿‡`magic-string` ç¬¬ä¸‰æ–¹åŒ…å·¥å…·å®Œæˆå­—ç¬¦ä¸²çš„æ›¿æ¢åè¿”å›ã€‚



**ä»£ç é€»è¾‘**ï¼š

1. è¯»å–è½¬åŒ–è§„åˆ™å­—æ®µã€‚ç”±äº`myReplace` ç»„ä»¶åªæ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œé…ç½®å­—æ®µå’Œæ›¿æ¢è§„åˆ™æ··åˆåœ¨ä¸€èµ·äº†ï¼Œæ‰€ä»¥éœ€è¦è¿‡æ»¤è§„åˆ™ï¼Œé€šè¿‡ `getReplacements` åˆ é™¤ `delimiters/include/exclude` ç­‰å±æ€§ã€‚

2. è§„åˆ™æ”¯æŒå›è°ƒæ ¼å¼ï¼Œå¦‚ `{"process.env.World": () => "'Jack!!!'"}`ï¼Œé€šè¿‡ `mapToFunctions` å°†æ‰€æœ‰è§„åˆ™é”®å€¼æ”¹ä¸ºï¼š`Record<string,function> ` æ ¼å¼ã€‚

3. å¯¹æ›¿æ¢é”®å€¼è¿›è¡Œ `escape` å¤„ç†ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åç»­ä½¿ç”¨  `magic string` åŒ…æ›¿æ¢è¢«æ­£åˆ™åŒ¹é…ã€‚

4. ç”Ÿæˆæ›¿æ¢è§„åˆ™ï¼Œå¦‚ï¼š`/\b(process\.env\.Hello|process\.env\.World)\b(?!\.)/g`

   å¸¦åŒ¹é…çš„é”®å€¼éƒ½é€šè¿‡ `(è§„åˆ™1|è§„åˆ™2|è§„åˆ™3)` åˆ†å‰²ï¼Œå‰åé€šè¿‡ `\b` å’Œ `\b(?!\.)` ä½œä¸ºå•è¯åˆ†éš”ã€‚

5. ä»¥ä¸Šå‡†å¤‡åšå®Œï¼Œå°±ç›´æ¥é€šè¿‡ `excuteReplacement` è¿›è¡Œå­—ç¬¦æ›¿æ¢å·¥ä½œã€‚

å…·ä½“ç®€æ˜“ç‰ˆå®ç°ä»£ç å¦‚ä¸‹ï¼š

```javascript
function myReplace(opts = {}) {
  /* æ­¤å¤„ \\b xxxx \\b ç”¨äºå•è¯è¾¹ç•ŒåŒºåˆ† */
  const { delimiters = ["\\b", "\\b(?!\\.)"] } = opts as any;
  const replacements = getReplacements(opts);
  const functionValues = mapToFunctions(replacements);
  const keys = Object.keys(functionValues).map(escape);
  const pattern = new RegExp(
    `${delimiters[0]}(${keys.join("|")})${delimiters[1]}`,
    "g",
  );
  return {
    name: "rollup:replace",
    transform(code, id) {
      if (!keys.length) return null;
      debugger;
      return executeReplacement(code, id);
    },
  };
  /* è¿‡æ»¤é¢å¤–å±æ€§ */
  function getReplacements(options) {
    const values = Object.assign({}, options);
    delete values.delimiters;
    return values;
  }

  /* å°†å¯¹è±¡è½¬åŒ–ä¸ºå‡½æ•° */
  function mapToFunctions(object) {
    return Object.keys(object).reduce((pre, cur) => {
      const functions = { ...pre };
      functions[cur] = ensureFunction(object[cur]);
      return functions;
    }, {});
  }

  /* å°† value è½¬åŒ–ä¸ºå‡½æ•° */
  function ensureFunction(functionOrValue) {
    if (typeof functionOrValue === "function") return functionOrValue;
    return () => functionOrValue;
  }

  function executeReplacement(code, id) {
    const magicString = new MagicString(code);
    let match;

    while ((match = pattern.exec(code))) {
      const start = match.index;
      const end = start + match[0].length;
      const replacement = String(functionValues[match[1]](id));
      magicString.overwrite(start, end, replacement);
    }
    const result = { code: magicString.toString() };
    return result;
  }
}

/* []å†…çš„ç‰¹æ®Šå­—ç¬¦éƒ½æ— éœ€æ·»åŠ è½¬ä¹‰ */
function escape(str) {
  return str.replace(/[-[\]/{}()*+?.\\^$|]/g, "\\$&");
}
```

 ä¸Šè¿°å¤„ç†ä¸­ä¸€å¤§æ®µä»£ç éƒ½æ˜¯åœ¨åšå‡†å¤‡å·¥ä½œï¼Œæœ€åè§¦å‘ `executeReplacement` å‡½æ•°æ‰§è¡Œæ›¿æ¢ï¼Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯æ­£åˆ™è§„åˆ™ï¼Œå¦‚ï¼š

- `escape` æ›¿æ¢ï¼š`str.replace(/[-[\]/{}()*+?.\\^$|]/g, "\\$&)"` ä¸ºæ‰€æœ‰ç‰¹æ®Šå­—ç¬¦æ·»åŠ åæ–œæ 

  é€šè¿‡ `[]` åŒ…è£¹ç‰¹æ®Šå­—ç¬¦æ—¶ï¼Œå°±æ— éœ€å¯¹æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦æ·»åŠ  `\` åæ–œæ ï¼Œé™¤ `]` æ¯”è¾ƒç‰¹æ®Šã€‚

  é€šè¿‡ `$&` å¯ä»¥è·å–åŒ¹é…å€¼ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

  ```javascript
  "[]{}".replace(/[-[\]/{}()*+?.\\^$|]/g, "\\$&")
  '\\[\\]\\{\\}'
  ```

- é€šè¿‡ `\b` å¯ä»¥ä½œä¸ºå•è¯è¾¹ç•Œï¼Œå¦‚è·å–å®Œæ•´çš„`cat` å•è¯

  ```javascript
  "cat catb".match(/\bcat\b/g)
  > ['cat']
  ```

  

