---
title: 09-Esbuild 插件开发实战
date: 2023-03-29 23:09:31
permalink: /pages/6e52d4/
categories:
  - 重点技术
  - 百问系列-深入浅出Vite
tags:
  - 
---

> 本节课程代码的[仓库](https://github.com/wangjs-jacky/Learn-Vite/tree/main/examples/11-vite-esbuild)：`11-vite-esbuild`

## 0.前言

本篇博客为《深入浅出 `Vite` 》掘金手册第九章的总结。



## 1.基础

###### 问题1：为什么 `Esbuild` 性能极高？

- `Go` 语言开发，`GO` 语言的优势主要体现两处，其一体现在编译型语言的特性，直接将逻辑代码构建为原生机器码，而 `js ` 先解析为字节码，在转化为机器码。其二为多线程共享内存共享。

- 从零造轮子：几乎没有使用三方库，这种"闭源"特性不仅体现在性能上，也使得在频繁操作 `AST` 场景下，能共享数据，免去了不同 `AST` 树的频繁解析和传递数据（`string`-> `ts`-> `js` -> `string`）。

  > 此特性很像 `Flutter` 采用 `dart` 语言带来的性能提升，通过自渲染引擎，打通客户端与原生端沟通成本，`dart` 取代传统的`js Bridge` 。

###### 问题2：可以通过哪两种方式来使用 `Esbuild` ?

有两种方式：**命令行** 和 **代码调用**。

- 命令行：

  ```json
  "command:npx": "npx esbuild src/index.jsx --bundle --outfile=dist/out.js",
  ```

- 代码调用：

  ```json
  "command:build": "node ./scripts/command/build.js",
  "command:serve": "node ./scripts/command/serve.js",
  "command:watch": "node ./scripts/command/watch.js",
  ```

  具体使用见下个问题。



###### 问题3：`ESBuild` 一共提供哪儿三种基础模式？能简单介绍下具体的使用方式吗?

**提供三种模式：`build`、`serve`、`watch`**

- `build`：在 `esbuild` 中此`api` 体现为异步，也同样提供了 `buildSync` 函数，但是不推荐使用。
- `serve`：可提供一个高性能的`静态文件服务`。（特别注意的是：与 `watch` 不同的时，只有当`请求`到来的时候，才会触发构建）
- `watch`：在 `watch` 下代码变动会触发重新打包。

**基础使用：**

```javascript
const buildConfig = {};
const result = await esbuild.build(buildConfig);
```

> 详细代码见[仓库](https://github.com/wangjs-jacky/Learn-Vite/tree/main/examples/11-vite-esbuild/scripts/command)，配置参数大致可分为以下四类：通用参数、esbuild 特有参数、开发环境参数、生产环境参数。

- 通用：

  - 入口：`entryPoints: [""]` 是一个数组。
  - 出口：`outdir: "dist"`
  - 指定模块语法规范：`iffe、esm、cjs`

- `esbuild` 特有参数：

  - `metafile:true` 开启会在结果中注入元信息。（处理依赖相关时需要）

  - `loader: {}` 与`webpack` 中的 `loader` 概念相同 ，针对不同格式的文件，调用不同的 `loader` 进行处理。

    > 内置的 `loader` 如下：
    >
    > `export type Loader = 'base64' | 'binary' | 'copy' | 'css' | 'dataurl' | 'default' | 'empty' | 'file' | 'js' | 'json' | 'jsx' | 'text' | 'ts' | 'tsx'`

    - `{".png":"base64"}` ：将图片格式处理为 `base64` 格式。
    - `{".jsx": "jsx"}`：处理 `jsx` 格式。

- 开发环境：支持`sourcemap` 生成 `map` 文件。

- 生产环境：

  - 是否打包：`bundle:true`，此参数配置的区别在于是否处理第三方依赖。

    > 可以写一个插件实现下面的内容折叠。

    通过观察 `metafile` 可以观察输入输出。

    - `bundle: false` 时，
  
      ```bash
      $ npm run command:build
      
      > 11-vite-esbuild@1.0.0 command:build
      > node ./scripts/command/build.js
      
      result {
        errors: [],
        warnings: [],
        outputFiles: undefined,
        metafile: {
          inputs: { 'src/react-component.jsx': [Object] },
          outputs: {
            'dist/command/build/react-component.js.map': [Object],
            'dist/command/build/react-component.js': [Object]
          }
        },
        mangleCache: undefined
      }
      ```

    - `bundle: true` 时，
  
      ```bash
      $ npm run command:build
      
      > 11-vite-esbuild@1.0.0 command:build
      > node ./scripts/command/build.js
      
      result {
        errors: [],
        warnings: [],
        outputFiles: undefined,
        metafile: {
          inputs: {
            '../../node_modules/.pnpm/react@18.2.0/node_modules/react/cjs/react.development.js': [Object],
            '../../node_modules/.pnpm/react@18.2.0/node_modules/react/index.js': [Object],
            '../../node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom-server-legacy.browser.development.js': [Object],
            '../../node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom-server.browser.development.js': [Object],
            '../../node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/server.browser.js': [Object],
            'src/react-component.jsx': [Object]
          },
          outputs: {
            'dist/command/build/react-component.js.map': [Object],
            'dist/command/build/react-component.js': [Object]
          }
        },
        mangleCache: undefined
      }
      ```

  - `format: "esm"`  下可开启 `splitting:true` 可进行分包操作。
  
  - `bundle: true` 属性下，可额外通过 `external:[]` 指定不需要打入的第三方依赖。
  
  - `minify: true` 开启压缩操作。
  
  -  `write: true` 和 `webpack-dev-server` 一样默认是将产物输出到内存，开启后，可以将产物写进磁盘。

## 2. 进阶

###### 问题4：`Esbuild` 插件作为一个对象包含哪两个属性？

###### 问题5：`ESbuild` 插件本质上是什么？有哪儿个钩子可供使用，请简要介绍？

###### 问题5：`onResolve` 和 `onLoad` 钩子的使用方式？

###### 问题6：`onStart` 和 `onEnd` 钩子的使用方式？



## 3. 实践

###### 问题7：如何基于 `ESbuild` 编写一个支持识别 `http` 模块插件，简述大致流程？

###### 问题8：如何基于 `ESbuild` 编写一个 `HTML` 构建插件，将上述的 `js` 插入对预制的 `html` 模板，请简述大概流程？





