(window.webpackJsonp=window.webpackJsonp||[]).push([[124],{527:function(t,s,a){"use strict";a.r(s);var e=a(19),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"_0-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-前言"}},[t._v("#")]),t._v(" 0.前言")]),t._v(" "),a("p",[t._v("本篇博客为"),a("a",{attrs:{href:"https://github.com/wangjs-jacky/webpack_demo01",target:"_blank",rel:"noopener noreferrer"}},[t._v("webpack_deom01"),a("OutboundLink")],1),t._v("项目仓库笔记，主要有以下内容：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("AST")]),t._v(" 的含义及其应用")]),t._v(" "),a("li",[a("code",[t._v("Babel")]),t._v("中操作"),a("code",[t._v("AST")]),t._v(" 树的"),a("code",[t._v("API")]),t._v("说明。")]),t._v(" "),a("li",[t._v("使用"),a("code",[t._v("AST")]),t._v(" 操作完成两个案例:\n"),a("ul",[a("li",[t._v("将 "),a("code",[t._v("let")]),t._v(" 转化为 "),a("code",[t._v("var")]),t._v("。")]),t._v(" "),a("li",[t._v("将 "),a("code",[t._v("import")]),t._v(" 导入的模块保存在数组中("),a("code",[t._v("depRelation")]),t._v(")，实现对模块的静态分析。")])])])]),t._v(" "),a("h2",{attrs:{id:"_1-什么是ast-及ast的应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-什么是ast-及ast的应用"}},[t._v("#")]),t._v(" 1.什么是AST，及AST的应用")]),t._v(" "),a("p",[a("code",[t._v("AST")]),t._v(" 是 "),a("code",[t._v("Abstract Syntax Tree")]),t._v(" 的简称，是前端工程化绕不过的一个名词。它涉及到工程化诸多环节的应用，比如:")]),t._v(" "),a("ol",[a("li",[t._v("如何将 "),a("code",[t._v("Typescript")]),t._v(" 转化为 "),a("code",[t._v("Javascript")]),t._v(" ("),a("code",[t._v("typescript")]),t._v(")")]),t._v(" "),a("li",[t._v("如何将 "),a("code",[t._v("SASS/LESS")]),t._v(" 转化为 "),a("code",[t._v("CSS")]),t._v(" ("),a("code",[t._v("sass/less")]),t._v(")")]),t._v(" "),a("li",[t._v("⭐️如何将 "),a("code",[t._v("ES6+")]),t._v(" 转化为 "),a("code",[t._v("ES5 (babel)")])]),t._v(" "),a("li",[t._v("如何将 "),a("code",[t._v("Javascript")]),t._v(" 代码进行格式化 ("),a("code",[t._v("eslint/prettier")]),t._v(")")]),t._v(" "),a("li",[t._v("如何识别 React 项目中的"),a("code",[t._v("JSX")]),t._v("("),a("code",[t._v("babel")]),t._v(")")]),t._v(" "),a("li",[t._v("❓"),a("code",[t._v("GraphQL")]),t._v("、"),a("code",[t._v("MDX")]),t._v("、"),a("code",[t._v("Vue SFC")]),t._v(" 等等")])]),t._v(" "),a("p",[t._v("而在语言转换的过程中，实质上就是对其 "),a("code",[t._v("AST")]),t._v(" 的操作，核心步骤就是 "),a("code",[t._v("AST")]),t._v(" 三步走")]),t._v(" "),a("ol",[a("li",[a("p",[a("code",[t._v("Code -> AST (Parse)")])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("AST -> AST (Transform)")])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("AST -> Code (Generate)")])])])]),t._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://wjs-tik.oss-cn-shanghai.aliyuncs.com/image-20220327141204080.png"}}),t._v(" "),a("p",[t._v("在"),a("code",[t._v("案例1")]),t._v("中使用"),a("code",[t._v("babel")]),t._v("完成"),a("code",[t._v("AST")]),t._v("转换，实现变量声明("),a("code",[t._v("VariableDeclaration")]),t._v(")语法的降级(将"),a("code",[t._v("let")]),t._v("改为"),a("code",[t._v("var")]),t._v(")。")]),t._v(" "),a("p",[t._v("初始"),a("code",[t._v("code")]),t._v("为：")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("let a = 'let'; let b = 2")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("code",[t._v("let a = 'let'")]),t._v(" 将被解析为以下的"),a("code",[t._v("AST")]),t._v(" 树结构：")]),t._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"body"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VariableDeclaration"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"declarations"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VariableDeclarator"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Identifier"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"init"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"StringLiteral"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"extra"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"rawValue"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"let"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"raw"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"'let'\"")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"value"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"let"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"let"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ...\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br")])]),a("p",[t._v("上述 "),a("code",[t._v("AST")]),t._v(" 基本将 "),a("code",[t._v("code")]),t._v(" 的行为做一个很好的表征：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("等式左侧：")]),t._v(" "),a("ul",[a("li",[t._v("变量声明："),a("code",[t._v('type: "VariableDeclaration"')])]),t._v(" "),a("li",[t._v("类型："),a("code",[t._v('kind: "let"')])])])]),t._v(" "),a("li",[a("p",[t._v("等式右侧：")]),t._v(" "),a("ul",[a("li",[t._v("值的类型：字符串 "),a("code",[t._v("StringLiteral")]),t._v("、数值 "),a("code",[t._v("NumericLiteral")])]),t._v(" "),a("li",[t._v("值为："),a("code",[t._v('value: "let"')])])])])]),t._v(" "),a("h2",{attrs:{id:"_2-ast树操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-ast树操作"}},[t._v("#")]),t._v(" 2.AST树操作")]),t._v(" "),a("p",[t._v("这部分主要借助的"),a("code",[t._v("Babel")]),t._v("库提供的三个底层的"),a("code",[t._v("API")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" parse "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@babel/parser"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" traverse "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@babel/traverse"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" generate "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@babel/generator"')]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("转化操作：")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("let a = 'let'; let b = 2")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// parse: Code => AST（引用地址）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ast "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" sourceType"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"module"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// traverse : AST => Code ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 无输出，直接修改的原 AST 树")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("traverse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("enter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("item")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VariableDeclaration"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kind "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"let"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kind "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"var"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// generate")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("generate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("h2",{attrs:{id:"_3-babel-家族简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-babel-家族简介"}},[t._v("#")]),t._v(" 3. Babel 家族简介")]),t._v(" "),a("p",[t._v("一般情况而言，我们不会直接使用"),a("code",[t._v("parser")]),t._v("、"),a("code",[t._v("traverse")]),t._v("、"),a("code",[t._v("generator")]),t._v("这三个 "),a("code",[t._v("Api")]),t._v(" 对 "),a("code",[t._v("AST")]),t._v(" 树进行操作，"),a("code",[t._v("Babel")]),t._v(" 已经封装好更为简洁的操作"),a("code",[t._v("AST")]),t._v("树的"),a("code",[t._v("API")]),t._v("，这些库封装在"),a("code",[t._v("@babel/core")]),t._v(" ，主要提供以下两类"),a("code",[t._v("AST")]),t._v("操作能力:")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("可以直接生成 "),a("code",[t._v("code")]),t._v(" 的 "),a("code",[t._v("API")]),t._v(":")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("从 "),a("code",[t._v("code")]),t._v(" 转化为 "),a("code",[t._v("code")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("transform")]),t._v(" 、"),a("code",[t._v("transformSync")])])])]),t._v(" "),a("li",[a("p",[t._v("从 "),a("code",[t._v("file")]),t._v(" 转化为 "),a("code",[t._v("code")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("transformFile")]),t._v("、"),a("code",[t._v("transformFileSync")]),t._v("：大部分情况下，"),a("code",[t._v("code")]),t._v("的形式不是以字符串的形式，而是需要通过"),a("code",[t._v("fs.readFile")]),t._v("的形式读取的，具体见"),a("code",[t._v("案例3")]),t._v("。")])])]),t._v(" "),a("li",[a("p",[t._v("从 "),a("code",[t._v("Ast")]),t._v(" 转化为 "),a("code",[t._v("code")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("transformFromAst")]),t._v("、"),a("code",[t._v("transformFromAstSync")]),t._v("：")])])])])]),t._v(" "),a("li",[a("p",[t._v("与解析相关的 "),a("code",[t._v("API")]),t._v(":")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("parse")]),t._v(" ：仅支持 "),a("code",[t._v("babel v7")]),t._v(" 之前的版本，"),a("code",[t._v("v8")]),t._v(" 不再对该 "),a("code",[t._v("api")]),t._v("向后兼容。")]),t._v(" "),a("li",[t._v("新版请使用："),a("code",[t._v("parseSync")]),t._v(" 和 "),a("code",[t._v("parseAsync")])])])])]),t._v(" "),a("blockquote",[a("p",[t._v("详细，各"),a("code",[t._v("APi")]),t._v("的使用见："),a("a",{attrs:{href:"https://www.babeljs.cn/docs/babel-core",target:"_blank",rel:"noopener noreferrer"}},[t._v("@babel/core"),a("OutboundLink")],1),t._v(" 官方文档")])]),t._v(" "),a("p",[t._v("上述"),a("code",[t._v("api")]),t._v("在使用时，还可在转化时设置"),a("code",[t._v("option")]),t._v("，如在"),a("code",[t._v("babel")]),t._v("中内置着许多的"),a("code",[t._v("preset")]),t._v("（预制）")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" babel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transformFromAstSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" es6Code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  presets"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@babel/preset-env"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("其中， "),a("code",[t._v("@babel/preset-env")]),t._v(" 是一个智能预设，允许当前环境使用最新的 "),a("code",[t._v("JavaScript")]),t._v("而不需要针对目标宿主环境进行额外的调整，"),a("code",[t._v("preset-env")]),t._v("将会所有 "),a("code",[t._v("ES2015-ES2020")]),t._v(" 代码自动转化为 "),a("code",[t._v("ES5")]),t._v(" 代码。")]),t._v(" "),a("blockquote",[a("p",[t._v("具体实践见：案例3")])]),t._v(" "),a("h2",{attrs:{id:"_4-使用ast树-分析-webpack-模块依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-使用ast树-分析-webpack-模块依赖"}},[t._v("#")]),t._v(" 4.使用AST树：分析 Webpack 模块依赖")]),t._v(" "),a("p",[t._v("在【案例4】中，存在 "),a("code",[t._v("4")]),t._v(" 个 "),a("code",[t._v("project")]),t._v("文件夹，分别对应着以下几种情况：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("project_1")]),t._v("与"),a("code",[t._v("deps.ts")]),t._v("文件：基础模块分析实现。")]),t._v(" "),a("li",[a("code",[t._v("project_2")]),t._v("与"),a("code",[t._v("deps2.ts")]),t._v("文件：递归分析深层依赖。")]),t._v(" "),a("li",[a("code",[t._v("project_3")]),t._v("与"),a("code",[t._v("deps3.ts")]),t._v("文件：可以对循环依赖进行静态分析。")])]),t._v(" "),a("p",[t._v("核心实现原理：")]),t._v(" "),a("p",[t._v("检查代码中是否有 "),a("code",[t._v('import "./xxx.js"')]),t._v(" 这段代码，也即 "),a("code",[t._v("AST")]),t._v(" 树中搜索 "),a("code",[t._v("path.node.type")]),t._v(" 是否有"),a("code",[t._v("ImportDeclaration")]),t._v("类型。如果存在则将"),a("code",[t._v("path.node.source.value")]),t._v("中的内容存入"),a("code",[t._v("depRelation")]),t._v("数组中。")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("traverse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("enter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ImportDeclaration"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// path.node.source.value 往往是一个相对路径，如 ./a.js，需要先把它转为一个绝对路径")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" depAbsolutePath "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dirname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filepath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 然后转为项目路径")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" depProjectPath "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getProjectPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depAbsolutePath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把依赖写进 depRelation")]),t._v("\n        depRelation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depProjectPath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("collectCodeAndDeps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("depAbsolutePath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("h2",{attrs:{id:"_5-总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-总结"}},[t._v("#")]),t._v(" 5.总结：")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("AST相关：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("parse")]),t._v(": 把代码 "),a("code",[t._v("code")]),t._v(" 变成 "),a("code",[t._v("AST")]),t._v("。")]),t._v(" "),a("li",[a("code",[t._v("traverse")]),t._v(": 遍历 "),a("code",[t._v("AST")]),t._v("进行修改。")]),t._v(" "),a("li",[a("code",[t._v("generate")]),t._v(": 把 "),a("code",[t._v("AST")]),t._v(" 变成代码 "),a("code",[t._v("code2")]),t._v("。")])])]),t._v(" "),a("li",[a("p",[t._v("工具：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("@babel/parser")])]),t._v(" "),a("li",[a("code",[t._v("@babel/traverse")])]),t._v(" "),a("li",[a("code",[t._v("@babel/generator")])]),t._v(" "),a("li",[a("code",[t._v("@babel/core")]),t._v(" 包含前三者")]),t._v(" "),a("li",[a("code",[t._v("@babel/preset-env")]),t._v(" 内置了"),a("code",[t._v("ES6")]),t._v("转"),a("code",[t._v("ES5")]),t._v("的很多规则")])])]),t._v(" "),a("li",[a("p",[t._v("构建了一个 "),a("code",[t._v("dep.ts")]),t._v(" 函数实现对模块的依赖分析。")])])]),t._v(" "),a("h2",{attrs:{id:"_6-参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-参考资料"}},[t._v("#")]),t._v(" 6.参考资料：")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://q.shanyue.tech/engineering/756.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("程序员山月"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);