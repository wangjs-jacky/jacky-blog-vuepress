(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{490:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_0-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-前言"}},[s._v("#")]),s._v(" 0.前言")]),s._v(" "),a("blockquote",[a("p",[s._v("本节博客代码"),a("a",{attrs:{href:"https://github.com/wangjs-jacky/Learn-Vite/tree/main/examples/07-vite-prebundle",target:"_blank",rel:"noopener noreferrer"}},[s._v("仓库"),a("OutboundLink")],1),s._v("，主要简述了预构建存在的问题，并且提前介绍了可能存在的一些坑点。")])]),s._v(" "),a("h2",{attrs:{id:"_1-概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-概念"}},[s._v("#")]),s._v(" 1.概念")]),s._v(" "),a("h3",{attrs:{id:"问题1-预构建解决了什么问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题1-预构建解决了什么问题"}},[s._v("#")]),s._v(" 问题1：预构建解决了什么问题？")]),s._v(" "),a("p",[s._v("主要解决了两个问题：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("解决 "),a("strong",[s._v("请求瀑布流问题")]),s._v(" 。")]),s._v(" "),a("p",[s._v("正所谓有舍必有得，享受现代浏览器按需加载的好处的同时，也有弊端，即庞大的第三方依赖所导致的网络请求。")])]),s._v(" "),a("li",[a("p",[s._v("将 "),a("code",[s._v("cjs")]),s._v(" 包转化为 "),a("code",[s._v("esm")]),s._v(" 格式。")]),s._v(" "),a("p",[s._v("由于 "),a("code",[s._v("vite")]),s._v(" 强制要求所有模块依赖必须为 "),a("code",[s._v("esm")]),s._v(" 格式，但是 "),a("code",[s._v("npm")]),s._v(" 库并不是所有的包都提供这种格式。比如说大名鼎鼎的 "),a("code",[s._v("react")]),s._v(" 就只提供 "),a("code",[s._v("cjs")]),s._v(" 格式。")]),s._v(" "),a("p",[s._v("需要注意的是，上述的模块依赖不仅指的是直接依赖，间接依赖也必须为 "),a("code",[s._v("esm")]),s._v(" 格式。下面会举例 "),a("code",[s._v("@loadable/component")]),s._v(" 这个包，其本身具有 "),a("code",[s._v("ESM")]),s._v(" 格式产物，但是其间接依赖 "),a("code",[s._v("hoist-non-react-statics")]),s._v(" 及其子依赖 "),a("code",[s._v("react-is")]),s._v(" 为 "),a("code",[s._v("cjs")]),s._v(" 格式产物。")])])]),s._v(" "),a("h3",{attrs:{id:"问题2-构建结果存放位置-以及如何重新预构建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题2-构建结果存放位置-以及如何重新预构建"}},[s._v("#")]),s._v(" 问题2：构建结果存放位置？以及如何重新预构建？")]),s._v(" "),a("p",[s._v("预构建的产物会被存放在 "),a("code",[s._v("node_module/.vite/deps")]),s._v(" 目录下。")]),s._v(" "),a("p",[s._v("通过浏览器加载模块的时候就可以发现模块均从上述文件夹下引入的。")]),s._v(" "),a("p",[s._v("通过 "),a("code",[s._v("network")]),s._v(" 面板发现，开发时可以利用到浏览器缓，第二次请求时会从缓存中读取。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://wjs-tik.oss-cn-shanghai.aliyuncs.com/202304122254815.png",alt:""}})]),s._v(" "),a("p",[s._v("重新触发构建的条件：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("手动删除 "),a("code",[s._v("node_modules/.vite")]),s._v(" 目录。")])]),s._v(" "),a("li",[a("p",[s._v("在 "),a("code",[s._v("vite.config.js")]),s._v(" 中配置 "),a("code",[s._v("optimizeDeps")]),s._v(" 中将 "),a("code",[s._v("force")]),s._v(" 设置为 "),a("code",[s._v("true")])])]),s._v(" "),a("li",[a("p",[s._v("脚手架中使用 "),a("code",[s._v("npx vite --force")]),s._v(" 加上 "),a("code",[s._v("--force")]),s._v(" 参数。")]),s._v(" "),a("p",[s._v("上述参数为合成指令：底层的话其实是先通过 "),a("code",[s._v("npx vite optimize")]),s._v(" 对依赖进行预构建；再就是 "),a("code",[s._v("vite dev")]),s._v(" 启动服务器。")])])]),s._v(" "),a("h2",{attrs:{id:"_2-进阶"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-进阶"}},[s._v("#")]),s._v(" 2.进阶")]),s._v(" "),a("h3",{attrs:{id:"问题3-vite-中的预构建可能存在什么问题-如何优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题3-vite-中的预构建可能存在什么问题-如何优化"}},[s._v("#")]),s._v(" 问题3：vite 中的预构建可能存在什么问题？如何优化？")]),s._v(" "),a("p",[s._v("当 "),a("code",[s._v("vite")]),s._v(" 使用异步模块导入时，会存在无法分析第三方依赖的问题。")]),s._v(" "),a("p",[s._v("由于 "),a("code",[s._v("vite")]),s._v(" 是异步按需加载。因此不会提前对异步模块中的第三方模块进行依赖扫描。如果此时异步包中引入第三方包时会触发 "),a("strong",[s._v("二次依赖构建")]),s._v("。")]),s._v(" "),a("p",[s._v("优化方案：手动将可能会扫描的包提前配置到 "),a("code",[s._v("vite.config.js")]),s._v(" 中，避免开发阶段二次预构建的情况。")]),s._v(" "),a("p",[s._v("来看一个例子，在仓库代码中，"),a("code",[s._v("App.tsx")]),s._v(" 中通过 "),a("code",[s._v("importModule")]),s._v(" 动态引入了 "),a("code",[s._v("zh_CN.ts")]),s._v(" 这个包")]),s._v(" "),a("div",{staticClass:"language-tsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-tsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 预构建优化：动态导入 zh_CN.ts 模块，无法对其内部的模块进行分析 */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("importModule")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("m"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("./locales/")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("${")]),s._v("m"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v(".ts")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("importModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zh_CN"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("div")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("className")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("App"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// zh_CN")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" objectAssign "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"object-assign"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("而这个动态模块中又依赖了一个第三方包："),a("code",[s._v('"object-assign"')]),s._v("，若直接启动项目，则会在控制台提示：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜  Local:   http://127.0.0.1:5174/\n➜  Network: use --host to expose\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":18:40 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("vite"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ✨ new dependencies optimized: object-assign\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":18:40 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("vite"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ✨ optimized dependencies changed. reloading\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("在 "),a("code",[s._v("vite.config.ts")]),s._v(" 的 "),a("code",[s._v("optimizeDeps.include")]),s._v(" 配置可手动提前预构建。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// https://vitejs.dev/config/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("defineConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("react")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  optimizeDeps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    include"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"object-assign"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"问题4-预构建不想将某个包打进去-可不可以"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题4-预构建不想将某个包打进去-可不可以"}},[s._v("#")]),s._v(" 问题4：预构建不想将某个包打进去，可不可以？")]),s._v(" "),a("p",[s._v("可以，但是 "),a("strong",[s._v("不推荐")]),s._v(" 。")]),s._v(" "),a("p",[s._v("前面已经介绍预构建其中一个作用就是由 "),a("code",[s._v("esbuild")]),s._v(" 提供模块规范转化功能（后续博客也会详细这部分机制，到时可以在项目中手动插件实现）。")]),s._v(" "),a("p",[s._v("以 "),a("code",[s._v("@loadable/componets")]),s._v(" 举例，这个包本身支持 "),a("code",[s._v("ESM")]),s._v(" 格式。")]),s._v(" "),a("div",{staticClass:"language-tsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-tsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// https://vitejs.dev/config/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("defineConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("react")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  optimizeDeps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    exclude"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@loadable/component"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("如果直接 "),a("code",[s._v("excludes")]),s._v(" 会报错，控制台打印如下：")]),s._v(" "),a("p",[a("code",[s._v("Uncaught SyntaxError: The requested module '/@fs/Users/jiashengwang/Project/Learn-vite/node_modules/.pnpm/hoist-non-react-statics@3.3.2/node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js?v=5d0e453c' does not provide an export named 'default' (at loadable.esm.js?v=5d0e453c:7:8)")])]),s._v(" "),a("p",[s._v("提示 "),a("code",[s._v("hoist-non-react-statics")]),s._v(" 这个包缺少一个 "),a("code",[s._v("default")]),s._v(" 导出。什么情况下会存在这个报错，就是当包为"),a("code",[s._v("cjs")]),s._v(" 格式时会报这个错误。因为 "),a("code",[s._v("cjs")]),s._v(" 就没有 "),a("code",[s._v("default")]),s._v("。如果真实项目中 "),a("code",[s._v("esm")]),s._v(" 要导入 "),a("code",[s._v("cjs")]),s._v(" 包的话，需要在 "),a("code",[s._v("ts")]),s._v(" 中开启 "),a("code",[s._v("esModuleInterop")]),s._v(" 这个参数，嵌入一些辅助代码。")]),s._v(" "),a("p",[s._v("解决方案：就是将不满足要求的间接依赖抽出来。")]),s._v(" "),a("div",{staticClass:"language-tsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-tsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("defineConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("react")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  optimizeDeps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    include"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@loadable/component > hoist-non-react-statics"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@loadable/component > hoist-non-react-statics > react-is"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    exclude"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@loadable/component"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("新版 "),a("code",[s._v("@loadable/component")]),s._v(" 还会多依赖个 "),a("code",[s._v("react-is")]),s._v(" 库。")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("exclude")]),s._v(" 属性的前提是需要自己提前分析出包依赖的格式规范，可以发现这个操作是非常困难的。")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("下面顺便分析下 "),a("code",[s._v("exclude")]),s._v(" 前后模块依赖：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("exclude")]),s._v("前：")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://wjs-tik.oss-cn-shanghai.aliyuncs.com/202304122334740.png",alt:"image-20230412233413691"}})]),s._v(" "),a("p",[a("code",[s._v("@lodable_component")]),s._v(" 请求头为："),a("code",[s._v("http://127.0.0.1:5174/node_modules/.vite/deps/@loadable_component.js?v=9c67aeed")])]),s._v(" "),a("ul",[a("li",[a("code",[s._v("exclude")]),s._v(" 后：")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://wjs-tik.oss-cn-shanghai.aliyuncs.com/202304122334427.png",alt:"image-20230412233316581"}})]),s._v(" "),a("p",[s._v("直接导入的是 "),a("code",[s._v("loadable/component")]),s._v(" 提供的 "),a("code",[s._v("esm")]),s._v(" 模块，并且请求地址为："),a("code",[s._v("http://127.0.0.1:5174/@fs/.../node_modules/.pnpm/@loadable+component@5.15.3/node_modules/@loadable/component/dist/loadable.esm.js?v=27562b28")])]),s._v(" "),a("p",[s._v("是从 "),a("code",[s._v("node_modules/.pnpm")]),s._v(" 仓库中导出的。")]),s._v(" "),a("p",[s._v("并且会多出两个请求是上面配置的 "),a("code",[s._v("include")]),s._v(" 中的内容，因为这两个请求是从 "),a("code",[s._v(".vite/deps")]),s._v(" 中取出给 "),a("code",[s._v("loadasble.esm.js")]),s._v(" 引用的。")]),s._v(" "),a("h3",{attrs:{id:"问题5-遇到有些第三方包就是个坑-用不了怎么解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题5-遇到有些第三方包就是个坑-用不了怎么解决"}},[s._v("#")]),s._v(" 问题5：遇到有些第三方包就是个坑，用不了怎么解决？")]),s._v(" "),a("p",[s._v("举例："),a("code",[s._v("react-virtualized")]),s._v(" 包")]),s._v(" "),a("p",[s._v("由于无法保证第三方包的质量，有些包产物就是有问题的，对于此类问题就是具体问题具体分析，找到报错点。")]),s._v(" "),a("p",[s._v("首先说这个包的坑点在于下面这段 "),a("strong",[s._v("错语句")]),s._v("，"),a("code",[s._v("WindowScroller.js")]),s._v(" 并没有导出这个模块。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" bpfrpt_proptype_WindowScroller "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"../WindowScroller.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("好在用不到这段代码，因此第一种方案是直接到 "),a("code",[s._v("node_modules")]),s._v(" 中删除这端代码。")]),s._v(" "),a("p",[s._v("为了将 "),a("code",[s._v("node_modules")]),s._v(" 的更改记录保留下来，可以使用到 "),a("code",[s._v("patch")]),s._v(" 技术，新版 "),a("code",[s._v("pnpm")]),s._v(" 已支持 "),a("code",[s._v("patch")]),s._v(" 操作，否则需要安装 "),a("code",[s._v("patch-package")]),s._v("。")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("pnpm")]),s._v(" 新增 "),a("code",[s._v("patch")]),s._v(" 步骤如下：")]),s._v(" "),a("ol",[a("li",[a("p",[a("code",[s._v("pnpm patch react-virtualized@9.22.3")])]),s._v(" "),a("p",[s._v("注意需要明确指定出版本号，此时在终端会显示如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pnpm")]),s._v(" patch react-virtualized@9.22.3\nYou can now edit the following folder: /private/var/folders/j6/c5rrdls52jg_9crpkxt01tym0000gn/T/37cc1d7e255fd6737dd810e542253644\nOnce you're "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" with your changes, run "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pnpm patch-commit /private/var/folders/j6/c5rrdls52jg_9crpkxt01tym0000gn/T/37cc1d7e255fd6737dd810e542253644"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("然后就可以直接在 "),a("code",[s._v("node_modules")]),s._v(" 中修改了，修改结束后，根据上述提示输入：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pnpm")]),s._v(" patch-commit /private/var/folders/j6/c5rrdls52jg_9crpkxt01tym0000gn/T/37cc1d7e255fd6737dd810e542253644\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("修改结束后，会对应生成 "),a("code",[s._v("patches")]),s._v(" 文件夹，在 "),a("code",[s._v("package.json")]),s._v(" 新增：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"pnpm"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"patchedDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"react-virtualized@9.22.3"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"patches/react-virtualized@9.22.3.patch"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])]),s._v(" "),a("p",[s._v("第二种方案，则是使用 "),a("code",[s._v("ESBuild")]),s._v(" 插件的方式完成删除操作")]),s._v(" "),a("p",[s._v("插件开发也很简单就两步：")]),s._v(" "),a("ol",[a("li",[s._v("找到对应的模块入口。")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("replace")]),s._v(" 删除语句。")])]),s._v(" "),a("div",{staticClass:"language-tsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-tsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// vite.config.ts")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" esbuildPatchPlugin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"react-virtualized-patch"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("onLoad")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        filter"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 过滤插件 */")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("react"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("virtualized\\"),a("span",{pre:!0,attrs:{class:"token regex"}},[a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("dist\\/es\\/WindowScroller\\/utils\\/onScroll.js$")]),a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" text "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("promises"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"utf8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          contents"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" text"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("replace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'import { bpfrpt_proptype_WindowScroller } from \"../WindowScroller.js\";'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 插件加入 Vite 预构建配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  optimizeDeps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    esbuildOptions"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("esbuildPatchPlugin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);